# Classifying ligand-binding sites with deep neural network
Pytorch code to implement the Convolutional Neural Network (CNN) classifier of ligand-binding sites. The input data to CNN are 2-d images generated by [Bionoi](https://github.com/CSBG-LSU/bionoi).

## Dependencies
Install the dependency package using this file: ```dependency/pytorch_env.yml```. This denpendency file is exported by [Anaconda](https://www.anaconda.com/). To install the environment:
```
conda env create -f pytorch_env.yml
```

## Folders
* analyse: code for analyse the results.
* dependency: file containing dependency packages.
* images: generated images.
* log: log files.
* model: saved models after training.

## Codes and usage

### Training, validating and testing CNN model
* transfer_learning_cnn.py: code for 1-fold training on the images generated by Bionoi. Note that the directory of data should be specified and have following structure:
```
/control_vs_nulceotide/train/control/
/control_vs_nulceotide/train/nucleotide/
/control_vs_nulceotide/val/control/
/control_vs_nulceotide/val/nucleotide/
/control_vs_nulceotide/test/control/
/control_vs_nulceotide/test/nucleotide/

```
Usage:
```
python transfer_learning_cnn.py -op control_vs_nucleotide -data_dir_convtrol_nucleotide ../control_vs_nucleotide/
```

* transfer_learning_cnn_cv.py: code for 10-fold cross-validation. Note that the directory of data should be specified and have following structure:
```
/control_vs_nucleotide_cv/cv1/train/control/
/control_vs_nucleotide_cv/cv1/train/nucleotide/
/control_vs_nucleotide_cv/cv1/val/control/
/control_vs_nucleotide_cv/cv1/val/nucleotide/
/control_vs_nucleotide_cv/cv2/train/control/
/control_vs_nucleotide_cv/cv2/train/nucleotide/
/control_vs_nucleotide_cv/cv2/val/control/
/control_vs_nucleotide_cv/cv2/val/nucleotide/
...
```
Usage:
```
python transfer_learning_cnn_cv.py -op control_vs_nucleotide -data_dir_control_vs_nucleotide ../control_vs_nucleotide_cv/
```

* utils.py: classes and functions used by other codes.
Usage: N/A

* helper.py: helper functions such as calculate classification metrics.
Usage: N/A

* inference.py: run trained model on the test data and report the classification results. The data directory needs to be specified and have the same structure as transfer_learning_cnn.py
Usage:
```
python inference.py -op control_vs_nucleotide -data_dir_control_vs_nucleotide
```

### Generating saliency maps and heatmaps 
A pipepline which contains code from two repos is used to generated the significance scores for atoms. The pipeline is illustrated in the following figure. Note that the red letter "Bionoi" indicates that the corresponding code is from [Bionoi](https://github.com/CSBG-LSU/bionoi).   

![](https://github.com/wentaoveggiebird/bionoi_transfer_learning/blob/master/images/atom-score-pipeline.png)

* saliency_visual.py: generate a saliency map for an image to find the "implicit attention" that the neural networks are paying to, and visualize it. We use this module to see which part of the protein is important to the neural network to distinguish them. The input of the program should contain the classification task, index of the target image, and the directories of data and trained model.
Usage:
```
python saliency_visual.py -opMode control_vs_nucleotide -index 123 -dataDir_control_vs_nucleotide ../control_vs_nucleotide/ -modelDir_control_vs_nucleotide ./model/control_vs_nucleotide_resnet18.pt
```

* saliency_heatmap_gen.py: generate corresponding saliency maps and heatmaps (in the form of images) for a specified Voronoi image folder. The source folder (of Voronoi diagrams of pockets), target folder and model directory should be specified. 
Usage:
```
python saliency_heatmap_gen.py -op control_vs_nucleotide -src_dir_control_vs_nucleotide ../analyse/images-6dirs/control_vs_nucleotide/test/ -target_dir_control_vs_nucleotide ../control_vs_nucleotide_6dir_saliency_heatmaps/ -modelDir_control_vs_nucleotide ./model/control_vs_nucleotide_resnet18.pt
```

* saliency_gen.py: this code is part of work which is used to compute the significance score of each atom in the pocket. It generate 6 saliency maps of a pocket (each saliency map corresponds to a projecting direction), and add them into a dictionary, then stored in new pickle files. 
Usage:
```
python saliency_gen.py -op control_vs_nucleotide
```

* saliency_combine.py: this code is part of work which is used to compute the significance score of each atom in the pocket. It is used to combine the results generated by saliency_gen.py
Usage:
```
python saliency_combine.py -op control_vs_nucleotide
```

## Cite our work
